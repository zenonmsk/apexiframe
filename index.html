<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình xem Ứng dụng APEX</title>
    <!-- Tải Tailwind CSS để styling nhanh và responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thiết lập font Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Màu nền nhẹ */
        }
        /* Đảm bảo iframe chiếm toàn bộ không gian có thể */
        #apex-iframe-container {
            /* Chiều cao trừ đi header, margin và button bar (3.5rem) */
            height: calc(100vh - 6rem - 3.5rem); 
            min-height: 400px;
        }
        @media (max-width: 768px) {
            #apex-iframe-container {
                /* Header và button bar nhỏ hơn trên mobile */
                height: calc(100vh - 4rem - 3.5rem); 
            }
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        
        <!-- Header / Tiêu đề -->
        <header class="mb-4 bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-700">Trình xem Ứng dụng APEX</h1>
            <span class="text-sm text-gray-500 hidden sm:block">Nhúng ứng dụng bằng Iframe</span>
        </header>

        <!-- Container chính -->
        <main class="bg-white rounded-lg shadow-xl p-0 overflow-hidden">
            
            <!-- Thanh Công cụ và Thông báo -->
            <div class="p-4 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-3">
                 <div id="loading-message" class="text-center text-sm text-gray-600">
                    Đang tải ứng dụng Oracle APEX...
                </div>

                <div class="flex flex-row gap-3 w-full sm:w-auto">
                    <!-- NÚT QUAY LẠI TRANG TRƯỚC (Cục bộ) -->
                    <button 
                        onclick="window.history.back()"
                        class="px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition duration-150 ease-in-out text-sm w-1/2 sm:w-auto"
                        title="Quay lại lịch sử trang trước trong WebView (ví dụ: từ trang đăng nhập về trang chính)"
                    >
                        Quay lại trang trước
                    </button>
                    
                    <!-- NÚT MỞ LINK TRÊN TRÌNH DUYỆT GỐC -->
                    <button 
                        id="open-browser-button"
                        onclick="openExternalLink('https://docs.oracle.com/en/database/oracle/apex/')"
                        class="px-4 py-2 bg-pink-500 text-white font-semibold rounded-lg shadow-md hover:bg-pink-600 transition duration-150 ease-in-out text-sm w-1/2 sm:w-auto disabled:opacity-50"
                        title="Mở link ngoài bằng trình duyệt hệ thống (Safari/Chrome)"
                        disabled
                    >
                        Mở Link Ngoài
                    </button>
                </div>
            </div>


            <!-- Iframe chứa ứng dụng APEX -->
            <div id="apex-iframe-container" class="w-full relative">
                <!-- 
                    *** RẤT QUAN TRỌNG: THAY THẾ URL DƯỚI ĐÂY BẰNG URL APEX CỦA BẠN ***
                -->
                <iframe 
                    id="apex-app-frame"
                    src="https://oracleapex.com/ords/r/ttdat/test" 
                    frameborder="0" 
                    class="w-full h-full"
                    title="Ứng dụng Oracle APEX được nhúng"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-pointer-lock"
                ></iframe>
            </div>

            <!-- Footer / Chân trang -->
            <footer class="p-3 text-center text-xs text-gray-400 bg-gray-50 border-t border-gray-100">
                Sử dụng iframe để tích hợp các ứng dụng web.
            </footer>

        </main>
    </div>

    <script>
        const EXTERNAL_URL = 'https://oracleapex.com/ords/r/ttdat/test'; 
        const BROWSER_BUTTON = document.getElementById('open-browser-button');
        const LOADING_MESSAGE = document.getElementById('loading-message');

        /**
         * Hàm này được dùng để mở link ngoài, ưu tiên sử dụng hàm Native (Cầu nối) nếu có.
         * Nó sẽ kiểm tra sự tồn tại của window.native_openbrowser(url).
         * Nếu không có, nó sẽ fallback về Custom URL Scheme.
         * * @param {string} url - Link cần mở
         */
        function openExternalLink(url) {
            // Tạm thời vô hiệu hóa nút để tránh nhấp liên tục
            BROWSER_BUTTON.disabled = true;

            try {
                // *** BƯỚC 1: ƯU TIÊN SỬ DỤNG HÀM NATIVE (WINDOW.NATIVE_OPENBROWSER) ***
                // Kiểm tra xem hàm do Native App (WebView) cung cấp có tồn tại hay không.
                if (typeof window.Native_OpenBrowser === 'function') {
                    console.log("Sử dụng Native Bridge: window.native_openbrowser()");
                    window.Native_OpenBrowser(url);

                } else {
                    // *** BƯỚC 2: FALLBACK VỀ CUSTOM URL SCHEME (Dành cho trường hợp Native Bridge không được cài đặt) ***
                    console.warn("Native Bridge không tìm thấy. Fallback về Custom URL Scheme.");

                    const encodedUrl = encodeURIComponent(url);
                    const bridgeUrl = `app-bridge://open-external?url=${encodedUrl}`;
                    
                    // Sử dụng window.location.href để kích hoạt WebView
                    window.location.href = bridgeUrl;
                }
                
                // 3. Đặt lại nút (vì trang không thực sự load lại, mà WebView sẽ xử lý)
                setTimeout(() => {
                    BROWSER_BUTTON.disabled = false;
                }, 500); 

            } catch (e) {
                alert('Không thể mở liên kết. Vui lòng kiểm tra lại cấu hình Native Bridge (window.native_openbrowser).');
                console.error("Lỗi khi cố gắng gọi hàm mở link:", e);
                BROWSER_BUTTON.disabled = false;
            }
        }
        
        // Gắn hàm vào phạm vi toàn cục để nút có thể truy cập
        window.openExternalLink = openExternalLink;


        document.addEventListener('DOMContentLoaded', function() {
            const iframe = document.getElementById('apex-app-frame');

            // Ẩn thông báo tải và kích hoạt nút khi iframe tải xong
            iframe.onload = function() {
                LOADING_MESSAGE.classList.add('hidden');
                BROWSER_BUTTON.disabled = false; // Kích hoạt nút
            };

            // Cảnh báo nếu URL chưa được thay đổi
            if (iframe.src.includes("YOUR_APEX_APPLICATION_URL_HERE")) {
                LOADING_MESSAGE.innerHTML = '⚠️ **LỖI:** Vui lòng thay thế placeholder `YOUR_APEX_APPLICATION_URL_HERE` trong mã nguồn bằng URL APEX thực tế của bạn.';
                LOADING_MESSAGE.classList.remove('text-gray-600');
                LOADING_MESSAGE.classList.add('text-red-600', 'font-bold');
                BROWSER_BUTTON.disabled = true; // Vô hiệu hóa nút nếu chưa có URL APEX
            } else {
                 console.warn("Lưu ý: Nếu bạn gặp lỗi 'redirected too many times', vấn đề nằm ở cấu hình Xác thực (Authentication Scheme) của ứng dụng APEX, KHÔNG phải ở file HTML này.");
                 BROWSER_BUTTON.disabled = false;
            }
        });
    </script>
    
</body>
</html>
